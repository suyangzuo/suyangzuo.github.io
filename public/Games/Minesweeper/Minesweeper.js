// æ‰«é›·æ¸¸æˆä¸»é€»è¾‘
class æ‰«é›·æ¸¸æˆ {
  constructor() {
    this.æ¸¸æˆé…ç½® = {
      'ç®€å•': { è¡Œæ•°: 9, åˆ—æ•°: 9, é›·æ•°: 10 },
      'ä¸­ç­‰': { è¡Œæ•°: 16, åˆ—æ•°: 16, é›·æ•°: 40 },
      'å›°éš¾': { è¡Œæ•°: 16, åˆ—æ•°: 30, é›·æ•°: 99 }
    };
    
    this.å½“å‰éš¾åº¦ = 'ä¸­ç­‰';
    this.æ¸¸æˆçŠ¶æ€ = 'ready'; // å‡†å¤‡å¼€å§‹, æ¸¸æˆè¿›è¡Œä¸­, æ¸¸æˆèƒœåˆ©, æ¸¸æˆå¤±è´¥
    this.é›·åŒº = [];
    this.å·²æ­ç¤ºæ ¼å­ = [];
    this.å·²æ ‡è®°æ ¼å­ = [];
    this.å‰©ä½™é›·æ•° = 0;
    this.æ¸¸æˆæ—¶é—´ = 0;
    this.ç‚¹å‡»æ¬¡æ•° = 0;
    this.è®¡æ—¶å™¨ = null;
    this.é¦–æ¬¡ç‚¹å‡» = true;
    
    this.åˆå§‹åŒ–å…ƒç´ ();
    this.ç»‘å®šäº‹ä»¶();
    this.é‡ç½®æ¸¸æˆ();
  }
  
  åˆå§‹åŒ–å…ƒç´ () {
    this.é›·åŒºå®¹å™¨ = document.getElementById('é›·åŒº');
    this.éš¾åº¦é€‰æ‹©å™¨ = document.getElementById('éš¾åº¦');
    this.å‰©ä½™é›·æ•°æ˜¾ç¤º = document.getElementById('å‰©ä½™é›·æ•°');
    this.æ¸¸æˆæ—¶é—´æ˜¾ç¤º = document.getElementById('æ¸¸æˆæ—¶é—´');
    this.ç‚¹å‡»æ¬¡æ•°æ˜¾ç¤º = document.getElementById('ç‚¹å‡»æ¬¡æ•°');
    this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º = document.getElementById('æ¸¸æˆçŠ¶æ€');
    this.é‡ç½®æŒ‰é’® = document.querySelector('.é‡ç½®æ¸¸æˆ');
    
    // ç¡®ä¿é‡ç½®æŒ‰é’®å­˜åœ¨
    if (!this.é‡ç½®æŒ‰é’®) {
      console.error('é‡ç½®æŒ‰é’®æœªæ‰¾åˆ°');
    }
  }
  
  ç»‘å®šäº‹ä»¶() {
    this.éš¾åº¦é€‰æ‹©å™¨.addEventListener('change', () => {
      this.å½“å‰éš¾åº¦ = this.éš¾åº¦é€‰æ‹©å™¨.value;
      this.é‡ç½®æ¸¸æˆ();
    });
    
    if (this.é‡ç½®æŒ‰é’®) {
      this.é‡ç½®æŒ‰é’®.addEventListener('click', () => {
        console.log('é‡ç½®æŒ‰é’®è¢«ç‚¹å‡»');
        this.é‡ç½®æ¸¸æˆ();
      });
    } else {
      console.error('é‡ç½®æŒ‰é’®æœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
    }
  }
  
  é‡ç½®æ¸¸æˆ() {
    console.log('é‡ç½®æ¸¸æˆå¼€å§‹');
    this.æ¸¸æˆçŠ¶æ€ = 'ready';
    this.é¦–æ¬¡ç‚¹å‡» = true;
    this.æ¸¸æˆæ—¶é—´ = 0;
    this.ç‚¹å‡»æ¬¡æ•° = 0;
    this.å·²æ­ç¤ºæ ¼å­ = [];
    this.å·²æ ‡è®°æ ¼å­ = [];
    
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    this.å‰©ä½™é›·æ•° = é…ç½®.é›·æ•°;
    
    this.åˆ›å»ºé›·åŒº(é…ç½®.è¡Œæ•°, é…ç½®.åˆ—æ•°);
    this.æ›´æ–°æ˜¾ç¤º();
    this.åœæ­¢è®¡æ—¶å™¨();
    this.æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º();
    
    console.log('é‡ç½®æ¸¸æˆå®Œæˆ');
  }
  
  åˆ›å»ºé›·åŒº(è¡Œæ•°, åˆ—æ•°) {
    this.é›·åŒºå®¹å™¨.innerHTML = '';
    this.é›·åŒºå®¹å™¨.style.gridTemplateColumns = `repeat(${åˆ—æ•°}, 1fr)`;
    this.é›·åŒºå®¹å™¨.style.gridTemplateRows = `repeat(${è¡Œæ•°}, 1fr)`;
    
    this.é›·åŒº = Array(è¡Œæ•°).fill().map(() => Array(åˆ—æ•°).fill(0));
    
    for (let è¡Œ = 0; è¡Œ < è¡Œæ•°; è¡Œ++) {
      for (let åˆ— = 0; åˆ— < åˆ—æ•°; åˆ—++) {
        const æ ¼å­ = document.createElement('div');
        æ ¼å­.className = 'æ ¼å­';
        æ ¼å­.dataset.è¡Œ = è¡Œ;
        æ ¼å­.dataset.åˆ— = åˆ—;
        
        æ ¼å­.addEventListener('click', (e) => this.å·¦é”®ç‚¹å‡»(è¡Œ, åˆ—, e));
        æ ¼å­.addEventListener('contextmenu', (e) => this.å³é”®ç‚¹å‡»(è¡Œ, åˆ—, e));
        
        this.é›·åŒºå®¹å™¨.appendChild(æ ¼å­);
      }
    }
  }
  
  å·¦é”®ç‚¹å‡»(è¡Œ, åˆ—, äº‹ä»¶) {
    if (this.æ¸¸æˆçŠ¶æ€ === 'won' || this.æ¸¸æˆçŠ¶æ€ === 'lost') return;
    
    äº‹ä»¶.preventDefault();
    this.ç‚¹å‡»æ¬¡æ•°++;
    
    if (this.é¦–æ¬¡ç‚¹å‡») {
      this.é¦–æ¬¡ç‚¹å‡» = false;
      this.æ¸¸æˆçŠ¶æ€ = 'playing';
      this.æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º();
      this.æ”¾ç½®åœ°é›·(è¡Œ, åˆ—);
      this.å¼€å§‹è®¡æ—¶å™¨();
    }
    
    if (this.å·²æ ‡è®°æ ¼å­.includes(`${è¡Œ}-${åˆ—}`)) return;
    
    this.æ­ç¤ºæ ¼å­(è¡Œ, åˆ—);
    this.æ›´æ–°æ˜¾ç¤º();
    this.æ£€æŸ¥æ¸¸æˆç»“æŸ();
  }
  
  å³é”®ç‚¹å‡»(è¡Œ, åˆ—, äº‹ä»¶) {
    äº‹ä»¶.preventDefault();
    if (this.æ¸¸æˆçŠ¶æ€ === 'won' || this.æ¸¸æˆçŠ¶æ€ === 'lost') return;
    
    const æ ¼å­æ ‡è¯† = `${è¡Œ}-${åˆ—}`;
    const æ ¼å­å…ƒç´  = this.é›·åŒºå®¹å™¨.children[è¡Œ * this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦].åˆ—æ•° + åˆ—];
    
    if (this.å·²æ ‡è®°æ ¼å­.includes(æ ¼å­æ ‡è¯†)) {
      // å–æ¶ˆæ ‡è®°
      this.å·²æ ‡è®°æ ¼å­ = this.å·²æ ‡è®°æ ¼å­.filter(id => id !== æ ¼å­æ ‡è¯†);
      æ ¼å­å…ƒç´ .classList.remove('å·²æ ‡è®°');
      æ ¼å­å…ƒç´ .textContent = '';
      this.å‰©ä½™é›·æ•°++;
    } else if (!this.å·²æ­ç¤ºæ ¼å­.includes(æ ¼å­æ ‡è¯†)) {
      // æ·»åŠ æ ‡è®°
      this.å·²æ ‡è®°æ ¼å­.push(æ ¼å­æ ‡è¯†);
      æ ¼å­å…ƒç´ .classList.add('å·²æ ‡è®°');
      æ ¼å­å…ƒç´ .textContent = 'ğŸš©';
      this.å‰©ä½™é›·æ•°--;
    }
    
    this.æ›´æ–°æ˜¾ç¤º();
  }
  
  æ”¾ç½®åœ°é›·(é¦–æ¬¡ç‚¹å‡»è¡Œ, é¦–æ¬¡ç‚¹å‡»åˆ—) {
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    let å·²æ”¾ç½®é›·æ•° = 0;
    
    while (å·²æ”¾ç½®é›·æ•° < é…ç½®.é›·æ•°) {
      const éšæœºè¡Œ = Math.floor(Math.random() * é…ç½®.è¡Œæ•°);
      const éšæœºåˆ— = Math.floor(Math.random() * é…ç½®.åˆ—æ•°);
      
      // ç¡®ä¿é¦–æ¬¡ç‚¹å‡»çš„ä½ç½®å’Œå‘¨å›´8ä¸ªä½ç½®ä¸æ”¾ç½®åœ°é›·
      if (Math.abs(éšæœºè¡Œ - é¦–æ¬¡ç‚¹å‡»è¡Œ) <= 1 && Math.abs(éšæœºåˆ— - é¦–æ¬¡ç‚¹å‡»åˆ—) <= 1) {
        continue;
      }
      
      if (this.é›·åŒº[éšæœºè¡Œ][éšæœºåˆ—] !== -1) {
        this.é›·åŒº[éšæœºè¡Œ][éšæœºåˆ—] = -1; // -1 è¡¨ç¤ºåœ°é›·
        å·²æ”¾ç½®é›·æ•°++;
      }
    }
    
    this.è®¡ç®—æ•°å­—();
  }
  
  è®¡ç®—æ•°å­—() {
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    
    for (let è¡Œ = 0; è¡Œ < é…ç½®.è¡Œæ•°; è¡Œ++) {
      for (let åˆ— = 0; åˆ— < é…ç½®.åˆ—æ•°; åˆ—++) {
        if (this.é›·åŒº[è¡Œ][åˆ—] !== -1) {
          let å‘¨å›´é›·æ•° = 0;
          
          for (let è¡Œåç§» = -1; è¡Œåç§» <= 1; è¡Œåç§»++) {
            for (let åˆ—åç§» = -1; åˆ—åç§» <= 1; åˆ—åç§»++) {
              const æ–°è¡Œ = è¡Œ + è¡Œåç§»;
              const æ–°åˆ— = åˆ— + åˆ—åç§»;
              
              if (æ–°è¡Œ >= 0 && æ–°è¡Œ < é…ç½®.è¡Œæ•° && 
                  æ–°åˆ— >= 0 && æ–°åˆ— < é…ç½®.åˆ—æ•° && 
                  this.é›·åŒº[æ–°è¡Œ][æ–°åˆ—] === -1) {
                å‘¨å›´é›·æ•°++;
              }
            }
          }
          
          this.é›·åŒº[è¡Œ][åˆ—] = å‘¨å›´é›·æ•°;
        }
      }
    }
  }
  
  æ­ç¤ºæ ¼å­(è¡Œ, åˆ—) {
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    const æ ¼å­æ ‡è¯† = `${è¡Œ}-${åˆ—}`;
    
    if (è¡Œ < 0 || è¡Œ >= é…ç½®.è¡Œæ•° || åˆ— < 0 || åˆ— >= é…ç½®.åˆ—æ•°) return;
    if (this.å·²æ­ç¤ºæ ¼å­.includes(æ ¼å­æ ‡è¯†)) return;
    
    this.å·²æ­ç¤ºæ ¼å­.push(æ ¼å­æ ‡è¯†);
    const æ ¼å­å…ƒç´  = this.é›·åŒºå®¹å™¨.children[è¡Œ * é…ç½®.åˆ—æ•° + åˆ—];
    æ ¼å­å…ƒç´ .classList.add('å·²æ­ç¤º');
    
    if (this.é›·åŒº[è¡Œ][åˆ—] === -1) {
      // è¸©åˆ°åœ°é›·
      æ ¼å­å…ƒç´ .classList.add('åœ°é›·çˆ†ç‚¸');
      æ ¼å­å…ƒç´ .textContent = 'ğŸ’£';
      this.æ¸¸æˆå¤±è´¥();
    } else if (this.é›·åŒº[è¡Œ][åˆ—] === 0) {
      // ç©ºç™½æ ¼å­ï¼Œé€’å½’æ­ç¤ºå‘¨å›´
      æ ¼å­å…ƒç´ .textContent = '';
      for (let è¡Œåç§» = -1; è¡Œåç§» <= 1; è¡Œåç§»++) {
        for (let åˆ—åç§» = -1; åˆ—åç§» <= 1; åˆ—åç§»++) {
          this.æ­ç¤ºæ ¼å­(è¡Œ + è¡Œåç§», åˆ— + åˆ—åç§»);
        }
      }
    } else {
      // æ•°å­—æ ¼å­
      æ ¼å­å…ƒç´ .textContent = this.é›·åŒº[è¡Œ][åˆ—];
      æ ¼å­å…ƒç´ .classList.add(`æ•°å­—${this.é›·åŒº[è¡Œ][åˆ—]}`);
    }
  }
  
  æ¸¸æˆå¤±è´¥() {
    this.æ¸¸æˆçŠ¶æ€ = 'lost';
    this.åœæ­¢è®¡æ—¶å™¨();
    this.æ˜¾ç¤ºæ‰€æœ‰åœ°é›·();
    this.æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º();
    æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ();
  }
  
  æ¸¸æˆèƒœåˆ©() {
    this.æ¸¸æˆçŠ¶æ€ = 'won';
    this.åœæ­¢è®¡æ—¶å™¨();
    this.æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º();
  }
  
  æ˜¾ç¤ºæ‰€æœ‰åœ°é›·() {
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    
    for (let è¡Œ = 0; è¡Œ < é…ç½®.è¡Œæ•°; è¡Œ++) {
      for (let åˆ— = 0; åˆ— < é…ç½®.åˆ—æ•°; åˆ—++) {
        if (this.é›·åŒº[è¡Œ][åˆ—] === -1) {
          const æ ¼å­å…ƒç´  = this.é›·åŒºå®¹å™¨.children[è¡Œ * é…ç½®.åˆ—æ•° + åˆ—];
          if (!this.å·²æ ‡è®°æ ¼å­.includes(`${è¡Œ}-${åˆ—}`)) {
            æ ¼å­å…ƒç´ .classList.add('åœ°é›·');
            æ ¼å­å…ƒç´ .textContent = 'ğŸ’£';
          }
        }
      }
    }
  }
  
  æ£€æŸ¥æ¸¸æˆç»“æŸ() {
    const é…ç½® = this.æ¸¸æˆé…ç½®[this.å½“å‰éš¾åº¦];
    const æ€»æ ¼å­æ•° = é…ç½®.è¡Œæ•° * é…ç½®.åˆ—æ•°;
    const å·²æ­ç¤ºæ ¼å­æ•° = this.å·²æ­ç¤ºæ ¼å­.length;
    
    if (å·²æ­ç¤ºæ ¼å­æ•° === æ€»æ ¼å­æ•° - é…ç½®.é›·æ•°) {
      this.æ¸¸æˆèƒœåˆ©();
    }
  }
  
  å¼€å§‹è®¡æ—¶å™¨() {
    this.è®¡æ—¶å™¨ = setInterval(() => {
      this.æ¸¸æˆæ—¶é—´++;
      this.æ›´æ–°æ˜¾ç¤º();
    }, 1000);
  }
  
  åœæ­¢è®¡æ—¶å™¨() {
    if (this.è®¡æ—¶å™¨) {
      clearInterval(this.è®¡æ—¶å™¨);
      this.è®¡æ—¶å™¨ = null;
    }
  }
  
  æ›´æ–°æ˜¾ç¤º() {
    this.å‰©ä½™é›·æ•°æ˜¾ç¤º.textContent = this.å‰©ä½™é›·æ•°;
    this.æ¸¸æˆæ—¶é—´æ˜¾ç¤º.textContent = this.æ¸¸æˆæ—¶é—´;
    this.ç‚¹å‡»æ¬¡æ•°æ˜¾ç¤º.textContent = this.ç‚¹å‡»æ¬¡æ•°;
  }
  
  // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
  æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º() {
    switch (this.æ¸¸æˆçŠ¶æ€) {
      case 'ready':
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.textContent = 'å‡†å¤‡å¼€å§‹';
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.style.color = '#ffffff';
        break;
      case 'playing':
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.textContent = 'æ¸¸æˆè¿›è¡Œä¸­';
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.style.color = '#FFD700';
        break;
      case 'won':
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.textContent = 'æ¸¸æˆèƒœåˆ©';
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.style.color = '#44FF44';
        break;
      case 'lost':
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.textContent = 'æ¸¸æˆå¤±è´¥';
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.style.color = '#FF4444';
        break;
      default:
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.textContent = 'æœªçŸ¥çŠ¶æ€';
        this.æ¸¸æˆçŠ¶æ€æ˜¾ç¤º.style.color = '#ffffff';
    }
  }
}

// åˆå§‹åŒ–ä¸€ä¸‹
let æ‰«é›·æ¸¸æˆå®ä¾‹ = null;

//å¦‚æœè¾“äº†
document.addEventListener('DOMContentLoaded', () => {
  æ‰«é›·æ¸¸æˆå®ä¾‹ = new æ‰«é›·æ¸¸æˆ();
});

// åœ°é›·çˆ†ç‚¸çš„å£°éŸ³
const çˆ†ç‚¸éŸ³æ•ˆ = new Audio('/Games/Minesweeper/Audios/bomb.wav');

// åœ¨æ¸¸æˆå¤±è´¥æ—¶æ’­æ”¾éŸ³æ•ˆ
function æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ() {
  çˆ†ç‚¸éŸ³æ•ˆ.currentTime = 0; // é‡ç½®éŸ³é¢‘è¿›åº¦
  çˆ†ç‚¸éŸ³æ•ˆ.play();
}
